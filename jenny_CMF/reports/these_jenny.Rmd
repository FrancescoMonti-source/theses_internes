---
title:    "Thèse Jenny CMF"
subtitle: "Revue des pratiques gingivopériostoplastie"
author:   "Francesco Monti"
date:     "2023-07-25 12:26:12" # Automatic date
output: 
    bookdown::html_document2:
        toc:         yes        # Table of contents (toc): yes no
        toc_float:   yes        # yes no
        toc_depth:   3              # 1 2 3 4 5
        highlight : pygments      # default tango kate monochrome espresso pygments...
        highlight_downlit : FALSE      # TRUE to use the downlit package as syntax highlight engine to highlight inline code and R code chunks (including providing hyperlinks to function documentation). The package needs to be installed to use this feature.
        code_folding:    "hide"     # none show hide
        code_download:   yes        # yes no
        fig_caption: yes        # yes no
        fig_width : 7
        fig_height : 5
        fig_retina : 2
        theme:       default        # cerulean journal flatly readable paper sandstone ...
        df_print:    default        # paged kable tibble default
        number_sections: yes        # Automatic numbering of sections: yes no
        anchor_sections : FALSE
        section_divs : TRUE     # Wrap sections in <div> tags, and attach identifiers to the enclosing <div> rather than the header itself.
        dev : "png"                # Graphics device to use for figure output (defaults to png)
        self_contained : TRUE
        extra_dependencies : NULL    # Extra dependencies as a list of the html_dependency class objects typically generated by htmltools:htmlDependency().
        css : NULL     # CSS and/or Sass files to include. Files with an extension of .sass or .scss are compiled to CSS via sass::sass(). Also, if theme is a bslib::bs_theme() object, Sass code may reference the relevant Bootstrap Sass variables, functions, mixins, etc.
        includes : NULL        # Named list of additional content to include within the document (typically created using the includes function)
        keep_md : FALSE        # Keep the markdown file generated by knitting.
        lib_dir : NULL             #    Directory to copy dependent HTML libraries (e.g. jquery, bootstrap, etc.) into. By default this will be the name of the document with _files appended to it.
        md_extensions : NULL       # Markdown extensions to be added or removed from the default definition of R Markdown. See the rmarkdown_format for additional details.
        pandoc_args : NULL      # Additional command line options to pass to pandoc
        template : "default"
editor_options:
#   chunk_output_type: console
---

```{r libraries, echo = F, include=F}
library(tidyverse)     # The main "tidyverse" packages.
library(conflicted)    # Get a warning/error if several functions with the same name exist.
conflicts_prefer(dplyr::filter)
library(magrittr)      # Operator %>% and additional pipe-friendly functions.
library(pander)
library(Kendall)
library(psych)
library(lmtest)
library(knitr)         # Function `kable()` to convert data frames into tables for reports.
#knitr::opts_knit$set(root.dir='..')

library(kableExtra)        # Enhancing kable() possibilities
library(DT)            # Interactive tables for HTML documents (DataTables).
library(fmckage)
library(janitor)
library(ggthemes)

library(ProjectTemplate)
#setwd("..")
load.project()
```

```{r options, echo = F}
# Chunk options
knitr::opts_chunk$set(
  echo       = TRUE,    # Should blocks with program code be shown in knitted documents?
  eval       = TRUE,    # Should program code be evaluated?
  fig.height = 6,       # Default height for plots.
  fig.width  = 10,       # Default width for plots.
  fig.align  = "center", # Default alignment for plots in knitted documents.
  warning = F, 
  fig.fullwidth = T
)

# Options to format numbers
options(        # For more detais see ?options
  scipen = 8,   # Show at least 8 digits in numbers before converting to exponential notation.
    digits = 2,   # Number of significant digits to print numbers.
    OutDec = ".", # Default decimal separator to print numbers.
    knitr.kable.NA = NA # Replacement for NA values in knitr::kable()
)

# Set ggplot options
theme = theme_clean()+
    theme(  # You can choose a pre-defined theme or customize it further
    text = element_text(color = "black", size = 12),
    axis.title = element_text(face = "bold"),
    title = element_text(face = "bold"))
theme_set(theme)
```

```{r contexte, echo = F, include = F}
#   Technique de cette chirurgie : prendre de l’os de la crête iliaque et le greffer au niveau de l’os alvéolaire du
#   maxillaire, pour reconstruire l’os de la mâchoire supérieure dans les fentes labio palatines

#   Les buts de cette chirurgie : 
#   -améliorer l’aspect esthétique
#   -permettre aux dents de se placer sur l’arcade (en gros)
#   -fermer la fistule buco-nasale 

# 151 patients inclus, correspondant à 162 GPP (GINGIVOPÉRIOSTOPLASTIE) (car 11 patients ont 2 fentes = f. bilaterales)

```

# Epidemio {.tabset}

## Sexe

```{r sexe}
table_prop(epi$sexe) %>% 
  kable(caption = "Gender", col.names = c("Gender","n","%")) %>% 
  kable_paper() %>% 
  kable_styling(bootstrap_options = c("striped", "hover"))
```

## Fentes

```{r fentes}
##### Table 1
rbind(table_prop(epi$complete),
      table_prop(epi$cote)) %>% 
  mutate(var = c("No","Yes","Both","Right","Left","NA")) %>% # labels of feature column
  kable(col.names = c("Feature","n","%"), caption = "Cleft characteristics") %>%
  kable_paper() %>% 
  pack_rows(start_row = 1,end_row = 2,"Complete") %>% 
  pack_rows(start_row = 3,end_row = 6,"Affected side") %>% 
  kable_styling(bootstrap_options = c("striped", "hover"))

##### Table
tab = table(epi$complete,epi$cote, deparse.level = 2, useNA = "ifany") %>% 
  data.frame() %>%
  rename(complete = epi.complete, `affected side` = epi.cote, n = Freq) %>% 
  mutate(complete = rep(c("No","Yes"),4),
         "%" = n*100/sum(n),
         `affected side` = case_when(`affected side` == "bilaterale" ~ "Both",
                                     `affected side` == "droite" ~ "Right",
                                     `affected side` == "gauche" ~ "Left"),
         "Gender"=""
         ) %>% 
  `colnames<-`(str_to_title(colnames(.))) %>% adorn_totals()

tabf = table("gender"= epi$sexe[epi$sexe=="F"], 
             epi$complete[epi$sexe=="F"],
             epi$cote[epi$sexe=="F"], deparse.level = 2, useNA = "ifany") %>% 
  data.frame() %>%
  `colnames<-`(c("gender", "complete", "affected side", "n")) %>% 
  mutate(complete = case_when(complete == 0 ~ "No",
                              complete == 1 ~ "Yes"),
         "%" = n*100/sum(n),
         `affected side` = case_when(`affected side` == "bilaterale" ~ "Both",
                                     `affected side` == "droite" ~ "Right",
                                     `affected side` == "gauche" ~ "Left")
    ) %>% 
    `colnames<-`(str_to_title(colnames(.)))  %>% 
    arrange(desc(N)) %>% adorn_totals

tabm = table("gender"= epi$sexe[epi$sexe=="M"], 
             epi$complete[epi$sexe=="M"],
             epi$cote[epi$sexe=="M"], deparse.level = 2, useNA = "ifany") %>% 
  data.frame() %>%
  `colnames<-`(c("gender", "complete", "affected side", "n")) %>% 
  mutate(complete = case_when(complete == 0 ~ "No",
                              complete == 1 ~ "Yes"),
         "%" = n*100/sum(n),
         `affected side` = case_when(`affected side` == "bilaterale" ~ "Both",
                                     `affected side` == "droite" ~ "Right",
                                     `affected side` == "gauche" ~ "Left")
    ) %>% 
    `colnames<-`(str_to_title(colnames(.)))  %>% 
    arrange(desc(N)) %>% adorn_totals


 rbind(tab,tabf,tabm) %>% select(-Gender) %>% 
  kable(row.names = F, caption = "Clefts characteristics cross-table") %>%
  kable_paper() %>% 
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive")) %>% 
  add_footnote(c("NA = Not Available")) %>% 
  pack_rows("Overall",1,9) %>% 
  pack_rows("Females",10,18) %>% 
  pack_rows("Males",19,26)
```

## Fentes by sexe

```{r fentes by sexe, echo=F}
table("Gender"= epi$sexe, epi$complete,epi$cote, deparse.level = 2, useNA = "ifany") %>% 
  data.frame() %>%
  rename(complete = epi.complete, `affected side` = epi.cote, n = Freq) %>% 
  mutate(complete = case_when(complete == 0 ~ "No",
                              complete == 1 ~ "Yes"),
         "%" = n*100/sum(n),
         `affected side` = case_when(`affected side` == "bilaterale" ~ "Both",
                                     `affected side` == "droite" ~ "Right",
                                     `affected side` == "gauche" ~ "Left")
         ) %>% 
  `colnames<-`(str_to_title(colnames(.))) %>% 
  arrange(Gender,desc(N)) %>% select(-Gender) %>% 
  kable(caption = "Clefts characteristics cross-table") %>%
  kable_paper() %>% 
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive")) %>% 
  add_footnote(c("NA = Not Available")) %>% 
  pack_rows("Females",1,8) %>% 
  pack_rows("Males",9,16)


table(epi$sexe,epi$cote,epi$complete, deparse.level = 2, useNA = "ifany") %>% 
  data.frame() %>%
  group_by(epi.sexe) %>% 
  mutate("%"=Freq*100/sum(Freq)) %>%
  filter(Freq!=0) %>% 
  arrange(epi.sexe) %>% 
  ungroup() %>% 
  select(-epi.sexe) %>% 
  kable(caption = "Fentes by sexe") %>%
  kable_paper(lightable_options = "striped") %>% 
  pack_rows(start_row = 1,end_row = 4,"Femmes") %>% 
  pack_rows(start_row = 5,end_row = 8,"Hommes") %>%
  add_footnote(c("Complète 1/0 = oui/non",
                 "Bilatérale 1/0 = oui/non",
                 "NA = not available"))
```

# Etude {.tabset}
## Fentes operées
```{r fentes operées}
table(etude$bilaterale,etude$cote_opere) %>%
    as.data.frame() %>%
    mutate("%"=Freq*100/sum(Freq,na.rm=T)) %>%
    adorn_totals() %>% 
    kable(col.names = c("Fente","Coté operé","n","%")) %>% 
    kable_paper() %>% 
    kable_styling(bootstrap_options = c("striped", "hover"))
```

## Prelevement iliaque
```{r prelevement iliaque}
table(etude$prelevement_iliaque) %>% 
    as.data.frame() %>%
    mutate("%"=Freq*100/sum(Freq,na.rm=T)) %>% 
    adorn_totals() %>% 
    kable(col.names = c("Prelevement iliaque","n","%")) %>% 
  kable_paper() %>% 
    kable_styling(bootstrap_options = c("striped", "hover"))
```

## Age patients
```{r pyramid}
# Create the age groups using cut
etude$age_group <- cut(as.numeric(etude$age/12), breaks = seq(0, 20, 1), include.lowest = TRUE)

    # Calculate the counts for each age group and sex
tab <- etude %>%
    count(age_group, sexe, name = "count")

    # Create the plot
ggplot(data = tab, aes(x = age_group, y = ifelse(sexe == "F", -count, count), fill = sexe)) +
    geom_bar(stat = "identity", position = "identity") +
    scale_y_continuous(labels = abs, breaks = seq(-20,20,1)) +
    labs(title = "Pyramid Age", x = "Age (années)", y = "n", fill = "Sexe") +
    theme_minimal() +
    coord_flip()

```

```{r dispersion measures}
# Dispersion mesures
tab = describe(etude$age,fast = T) %>%
  round(2) %>% 
  as.data.frame %>%
  select(-1,-8) 

tab2 = tab %>% 
  mutate(across(mean:range, function(x) fmckage::convert_time(x,
                                                  from = "months", 
                                                  to = c("years","months","days"), 
                                                  warn_residual = F)))


all = tab2 %>% mutate(n="") %$% ifelse(.!="",paste0(tab," (",.,")"),tab) %>% 
  as.data.frame %>% 
  `colnames<-`(c("n","Mean","Sd","Min","Max","Range")) %>% 
  mutate(Gender = "") %>% relocate(Gender,.before = n)


# Dispersion mesures by sexe
tab = etude %>% 
  group_by(sexe) %>% 
  summarise(age = describe(age,fast = T)) %>% 
  unnest(cols = c(age)) %>% 
  mutate(across(mean:range, function(x) round(x, 2))) %>%  
    select(-vars,-se)

tab2 = tab %>% 
  mutate(across(mean:range ,function(x) convert_time(x,from = "months", to = c("years","months","days"))))


by_sex <- tab %>%
    mutate(mean = paste0(mean, " (", tab2$mean, ")"),
           sd = paste0(sd, " (", tab2$sd, ")"),
           min = paste0(min, " (", tab2$min, ")"),
           max = paste0(max, " (", tab2$max, ")"),
           range = paste0(range, " (", tab2$range, ")")) %>% 
  rename(Gender=sexe) %>% `colnames<-`(c("Gender","n","Mean","Sd","Min","Max","Range"))



rbind(all, by_sex) %>% 
    kable(row.names = F,
          caption = "Age - Dispersion measures (months)") %>% 
    kable_paper() %>% 
    kable_styling(bootstrap_options = c("striped", "hover"))






```

## Traitement ODF
```{r ttt odf}
# 1) Combien de patients ont eu un traitement ODF pré chir ?
etude %>% 
  distinct(patid, odf_prechir) %$%
  table_prop(odf_prechir)  %>% 
  kable(col.names = c("ODF prechir","n","%")) %>% 
  kable_paper() %>%
  add_footnote(c("ODF prechir 1/0 = oui/non",
                 "NA = not available"))


# 2) temps moyen d’une prise en charge ODF avant la chirurgie 
tab = describe(etude$odf_prechir_months, fast = T) %>% round(2) %>% 
  select(-1,-8) %>% 
  as.data.frame() 

tab2 = etude %>%
  group_by(sexe) %>%
  summarise(odf_prechir_months = describe(odf_prechir_months, fast = T)) %>% 
  unnest(cols = odf_prechir_months) %>% 
  mutate(across(mean:range, round, 2)) %>% 
  select(-2,-9) %>%
  column_to_rownames("sexe")
  
tab3 = rbind(tab,tab2) %>% 
  mutate(across(mean:range, function(x) convert_time(x, from = "months", to = c("years","months","days"))))


    # joining tables
rbind(tab,tab2,tab3) %>% 
  `row.names<-`(c("Tous","F","M","tous","f","m")) %>% 
    kable(col.names = c("n", "moyenne", "écart type","min","max","range"), 
          row.names = T,
          caption = "Durée prise en charge ODF pre chir - Mesures de dispersion", 
          digits = 2) %>% 
  kable_paper() %>% 
  pack_rows("Mois",1,3) %>% 
  pack_rows("Years - months - days",4,6)

```

## Temps hospitalisation
```{r duree hospit}
# Mesures de dispersion
t_hospit = describe(etude$duree_sej, fast = T)[-c(1,8)] %>% round(2)

tab1 = t_hospit %>% 
    tibble %>% 
    mutate(across(mean:range, function(x) convert_time(x, from="days", to = c("days","hours"))))

tab2 = t_hospit %>%
    tibble %>% 
    mutate(across(mean:range, function(x) convert_time(x, from="days", to = c("hours","minutes"))))

    # Binding
rbind(as.character(t_hospit),tab1,tab2) %>%  
    mutate(rownames = c("","Days","Hours")) %>% 
    column_to_rownames(var = "rownames") %>% 
    kable(row.names = T, 
          caption = "Temps d'hispitalisation - mesures de dispersion", 
          col.names = c("n", "moyenne", "écart type","min","max","range")) %>%
    kable_paper()

# Table durée hospitalisation
table_prop(etude$duree_sej, name = "Durée hospit (jours)") %>% 
    kable(caption = "Tableau durée sejour") %>%
    kable_paper()

```


## Age intervention vs ODF
```{r}
plot(etude$age,etude$odf_prechir)

etude %>% 
    ggplot()+
    geom_boxplot(aes(x = factor(odf_prechir), y = age))+
    scale_y_continuous(breaks = seq(0,300,12), labels = function(x) x/12)

etude %>% 
    ggplot()+
    geom_boxplot(aes(x = etat_bd, y = age))+
    scale_y_continuous(breaks = seq(0,300,12), labels = function(x) x/12)

etude %>% 
    ggplot()+
    geom_boxplot(aes(x = compliance_ttt, y = age))+
    scale_y_continuous(breaks = seq(0,300,12), labels = function(x) x/12)

```



## Suites
```{r suites}
table_prop(etude$complications, name = "complications") %>% 
    kable(caption = "Suites compliquées oui/non") %>% 
    kable_paper()
```

# Learning curve{.tabset}
## Graphe
```{r learning curve, message=F}
# Plot
lc %>% 
  #filter(double==0) %>% 
ggplot(aes(x = as_date(date), y = time, color = factor(interne, labels = c("Oui","Non"))))+
    geom_point(position = "identity", aes(shape = factor(double)), size = 2.5)+
    scale_shape_manual(values=c(16, 17))+ 
    scale_y_continuous(breaks = seq(0,300,20))+
    scale_x_date(labels = as.character(seq(2010,2024,1)), date_breaks = "1 year")+
    geom_smooth(method="loess", span = 0.75)+
    labs(title = "Evolution temps d'intervention",
         y = "Temps (minutes)",
         x = "Date intervention",
         shape = "Intervention bilatérale",
         color = "Interne")
```

Les lignes colorées du graphique montrent la tendance moyenne dans le temps pour chaque groupe : une pour les cas où le chirurgien effectue l'opération seul, et une autre pour les cas où il était assisté par un interne. Il s'agit en quelque sorte d'une "meilleure estimation" de la durée moyenne de l'opération à une date donnée, sur la base des données dont nous disposons.

La zone ombrée autour de chaque ligne représente notre incertitude quant à cette "meilleure estimation". Elle nous indique que si nous devions deviner la durée moyenne des opérations à une certaine date, nous sommes sûrs à 95 % que la moyenne réelle se situerait dans cette zone ombrée.

Imagine d'essayer de deviner le poids d'un patient qu'en le regardant. Ton meilleure estimation pourrait être le poids moyen des patients que tu as vu auparavant. Mais tu sais aussi que les patients, à parité de volume, peuvent être un peu plus légers ou plus lourds que cette moyenne car ils n'ont pas la même composition corporelle. La zone ombrée revient à dire : "Je suis presque sûr que le poids de ce patient est de l'ordre de ce chiffre, à quelque chose près".

Dans ce contexte, la zone ombrée représente notre "à peu près" pour le temps d'intervention moyen. Plus la zone ombrée est large, plus notre "meilleure estimation" est incertaine. Comme on a moins de données "avec interne", le dégrée d'incertitude est plus élevé.

## Tendance: Mann-Kendall
```{r mannkendall, message=F}
# Mann-Kendall test on the sorted data
mk = lc %>% arrange(date) %>% filter(double==0) %$% MannKendall(time)
  # Printint the results nicely
cbind("Tau" = round(mk$tau,3), "p-value" = pval_format(mk$sl)) %>% kable(caption ="Mann-Kendall test") %>% kable_paper()
```

Pour tester formellement une tendance, nous pouvons utiliser le test de tendance de Mann-Kendall, un test non paramétrique largement utilisé pour détecter les tendances dans les données de séries temporelles. Le test ne suppose pas de distribution spécifique des données et il est particulièrement utile lorsqu'il s'agit de données qui ne sont pas normalement distribuées.

La valeur tau du test de Mann-Kendall est une mesure de la force et de la direction de la tendance. La valeur tau est comprise entre -1 (forte tendance à la baisse) et 1 (forte tendance à la hausse). Une valeur de 0 indique l'absence de tendance. Dans notre cas, le tau est de -0,587, ce qui suggère une "forte" tendance à la baisse.

La valeur p est une mesure de la signification statistique du résultat du test. La convention veut qu'une valeur p inférieure à 0,05 soit considérée comme statistiquement significative. Dans notre cas, la valeur p est inférieure à 2e-16 (*p<0.001*), ce qui est extrêmement faible et, par conséquent, le résultat est hautement significatif sur le plan statistique.

En résumé, les résultats du test de Mann-Kendall indiquent qu'il existe une forte tendance à la baisse du temps d'intervention du chirurgien au cours des 13 années, et cette tendance est statistiquement significative. Cela signifie qu'on dispose de preuves solides pour suggérer que le chirurgien devient effectivement plus rapide au fil du temps (ce qui n'est pas surprenant en soit mais c'est cool de le prouver).

J'au exclu du test statistique les interventions doubles (qui sont seulement 6).


## Interne oui vs interne non

Dans le graphe, le fait que les zones ombrées des deux groupes ne se chevauchent pas beaucoup nous indique qu'il existe une différence notable entre les deux scénarios : lorsque le chirurgien travaille seul et lorsqu'il est assisté. Cela n'est pas une surprise et le graphe parle tellement clair que faire un test stat est un peu ridicule mais voici ce que ça donne si on fait un test de student (pour comparer la durée moyenne entre "avec interne" et "sans interne"). A nouveau moi j'ai exclu les 6 interventions bilatérale dans ce test (seulement 1 bilatérale et avec interne). La différence entre la moyenne des 2 groupes est le temps que l'interne fait gagner en moyenne.

```{r interne impact}
surgeon_alone <- lc$time[lc$interne == 0 & lc$double==0]
surgeon_with_helper <- lc$time[lc$interne == 1 & lc$double==0]

tstudent = t.test(surgeon_alone, surgeon_with_helper)

# P-value
data.frame("P-value", pval_format(tstudent$p.value)) %>% kable(col.names = c("",""), caption = "Test t student") %>% kable_paper()

# Mean difference between the groups
tstudent$estimate %>% 
  as.data.frame(row.names = c("AVEC interne", "SANS interne")) %>% 
  `colnames<-`("Temps (minutes)") %>% 
  kable(caption = "Temps moyen d'intervention") %>% 
  kable_paper()

```


```{r linear regression, include = F}
# Trying a lm()
model <- lm(time ~ date, data = lc)
summary(model)

# Testing the assumption of linear model
    # Residuals vs Fitted values plot
plot(model, which = 1)
    # Q-Q plot
qqnorm(residuals(model))
qqline(residuals(model))
    # Shapiro-Wilk test
shapiro.test(residuals(model))
    # Durbin Watson Test
dwtest(model)

# Both the Shapiro-Wilk test for normality and the Durbin-Watson test for independence suggest violations of the assumptions of the linear regression model.
# 
# Normality assumption: The Shapiro-Wilk test p-value is very small, which provides evidence against the hypothesis that your residuals are normally distributed. It implies that the distribution of your residuals deviates from a normal distribution.
# 
# Independence assumption: The Durbin-Watson test p-value is less than 0.05, indicating that there is a statistically significant autocorrelation in the residuals, which means the independence assumption is violated.

```






