---
title: "Thèse Jenny CMF"
author: "Francesco Monti"
date: "2023-07-25 12:26:12"
output:
  word_document: default
  officedown::rdocx_document: default
subtitle: Revue des pratiques gingivopériostoplastie
---

```{r libraries, echo = F, include=F}
library(tidyverse)     # The main "tidyverse" packages.
library(conflicted)    # Get a warning/error if several functions with the same name exist.
conflicts_prefer(dplyr::filter)
library(magrittr)      # Operator %>% and additional pipe-friendly functions.
library(pander)
library(Kendall)
library(psych)
library(lmtest)
library(knitr)         # Function `kable()` to convert data frames into tables for reports.
#knitr::opts_knit$set(root.dir='..')

library(kableExtra)        # Enhancing kable() possibilities
library(DT)            # Interactive tables for HTML documents (DataTables).
library(fmckage)
library(janitor)
library(ggthemes)

library(ProjectTemplate)
#setwd("..")
load.project()
library(officer)
library(flextable)
library(tabulator)
library(officedown)
```

```{r options, echo = F}
# Chunk options
knitr::opts_chunk$set(
  echo       = F,    # Should blocks with program code be shown in knitted documents?
  eval       = TRUE,    # Should program code be evaluated?
  #fig.height = 6,       # Default height for plots.
  #fig.width  = 10,       # Default width for plots.
  fig.align  = "center", # Default alignment for plots in knitted documents.
  #fig.fullwidth = T,
  warning = F 
)

# Options to format numbers
options(        # For more detais see ?options
    digits = 4  # Number of significant digits to print numbers.
)

# Set ggplot options
theme = theme_clean()+
    theme(  # You can choose a pre-defined theme or customize it further
    text = element_text(color = "black", size = 12),
    axis.title = element_text(face = "bold"),
    title = element_text(face = "bold"))
theme_set(theme)

# Flextable defaults
set_flextable_defaults(
    text.align = "center",
  font.family = "Helvetica",
  font.size = 11,
  padding = 2,
  #border.color = "#CCCCCC",
  line_spacing = 1,
  digits = 4,
  pct_digits = 2, 
  na_str = "", theme_fun = "theme_zebra"
  )

```

# Epidemio {.tabset}
## Sexe
```{r sexe}
proc_freq(epi, "sexe") %>% 
    set_table_properties(width=1,layout="autofit")
    

# table_prop(epi$sexe) %>% 
#   `colnames<-`(c("Gender","n","%")) %>% 
#   flextable()
  # kable(caption = "Gender", col.names = c("Gender","n","%")) %>% 
  # kable_paper() %>% 
  # kable_styling(bootstrap_options = c("striped", "hover"))
```

## Fentes
```{r fentes}
##### Table 1 ------------
# proc_freq(epi,"complete","cote", 
#           include.column_percent = F, 
#           include.row_percent = F) %>%
#     set_table_properties(width=1, layout="autofit")


df = tab(epi,sexe,cote,complete, round = 4) %>% 
    split(.$sexe) %>% 
    lapply(arrange,sexe,complete,desc(N),cote) %>%
    adorn_totals() %>% 
    do.call(rbind,.) %>% select(-cum_prop) %>% 
       `colnames<-`(c("Sexe","Coté","Complète", "N", "%")) %>% 
    mutate(`%` = `%`*100,
           Coté = coalesce(Coté,Sexe),
           Sexe = ifelse(Sexe == "Total", NA, Sexe)) 

df[c(7,14),c(1,2,3)] = NA

df %>% as_grouped_data(groups = c("Sexe")) %>% 
    flextable() %>% 
    set_table_properties(layout="autofit",width=1)


# df = rbind(table_prop(epi$complete),
#       table_prop(epi$cote)) %>% 
#   mutate(var = c("No","Yes","Both","Right","Left","NA"),
#          group = c(rep("Complete", 2), rep("Affected side", 4))) %>% 
#   relocate(group, .before = dplyr::first(colnames(.))) %>% 
#   as_grouped_data(groups = c("group"))  
#   
# flextable(df) %>% 
#   set_header_labels(group = "Feature", var = "", n = "N", prop = "%") %>% 
#   bold(j = 1, part = "body") %>%
#   bold(part = "header") %>%
#   set_table_properties(width = .75, layout = "autofit")
  # kable(col.names = c("Feature","n","%"), caption = "Cleft characteristics") %>%
  # kable_paper() %>% 
  # pack_rows(start_row = 1,end_row = 2,"Complete") %>% 
  # pack_rows(start_row = 3,end_row = 6,"Affected side") %>% 
  # kable_styling(bootstrap_options = c("striped", "hover"))

# Table2 prep -----------
# Table 2 ------
# tab(epi,sexe,complete, cote, round = 4) %>% 
#     arrange(sexe,desc(N)) %>% 
#     mutate(prop = paste(prop*100,"%"),
#            cum_prop = paste(cum_prop*100,"%")) %>% 
#     as_grouped_data(group="sexe") %>% 
#     as_flextable() %>% 
#     set_table_properties(width = 1, layout = "autofit")


# tab = table(epi$complete,epi$cote, deparse.level = 2, useNA = "ifany") %>% 
#   data.frame() %>%
#   rename(complete = epi.complete, `affected side` = epi.cote, n = Freq) %>% 
#   mutate(complete = rep(c("No","Yes"),4),
#          "%" = n*100/sum(n),
#          `affected side` = case_when(`affected side` == "bilaterale" ~ "Both",
#                                      `affected side` == "droite" ~ "Right",
#                                      `affected side` == "gauche" ~ "Left"),
#          "Gender"=""
#          ) %>% 
#   `colnames<-`(str_to_title(colnames(.))) %>% adorn_totals()
# 
# tabf = table("gender"= epi$sexe[epi$sexe=="F"], 
#              epi$complete[epi$sexe=="F"],
#              epi$cote[epi$sexe=="F"], deparse.level = 2, useNA = "ifany") %>% 
#   data.frame() %>%
#   `colnames<-`(c("gender", "complete", "affected side", "n")) %>% 
#   mutate(complete = case_when(complete == 0 ~ "No",
#                               complete == 1 ~ "Yes"),
#          "%" = n*100/sum(n),
#          `affected side` = case_when(`affected side` == "bilaterale" ~ "Both",
#                                      `affected side` == "droite" ~ "Right",
#                                      `affected side` == "gauche" ~ "Left")
#     ) %>% 
#     `colnames<-`(str_to_title(colnames(.)))  %>% 
#     arrange(desc(N)) %>% adorn_totals
# 
# tabm = table("gender"= epi$sexe[epi$sexe=="M"], 
#              epi$complete[epi$sexe=="M"],
#              epi$cote[epi$sexe=="M"], deparse.level = 2, useNA = "ifany") %>% 
#   data.frame() %>%
#   `colnames<-`(c("gender", "complete", "affected side", "n")) %>% 
#   mutate(complete = case_when(complete == 0 ~ "No",
#                               complete == 1 ~ "Yes"),
#          "%" = n*100/sum(n),
#          `affected side` = case_when(`affected side` == "bilaterale" ~ "Both",
#                                      `affected side` == "droite" ~ "Right",
#                                      `affected side` == "gauche" ~ "Left")
#     ) %>% 
#     `colnames<-`(str_to_title(colnames(.)))  %>% 
#     arrange(desc(N)) %>% adorn_totals
# 
# # Table 2 ------
# rbind(tab,tabf,tabm) %>%
#   relocate(Gender, .before = "Complete") %>% 
#   as_grouped_data(groups = "Gender") %>%
#   flextable() %>% 
#   bold(j = 1, part = "body") %>%
#   bold(part = "header") %>%
#   flextable::theme_apa() %>%
#   set_table_properties(width = .75, layout = "autofit")


 # rbind(tab,tabf,tabm) %>% select(-Gender) %>% 
 #  kable(row.names = F, caption = "Clefts characteristics cross-table") %>%
 #  kable_paper() %>% 
 #  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive")) %>% 
 #  add_footnote(c("NA = Not Available")) %>% 
 #  pack_rows("Overall",1,9) %>% 
 #  pack_rows("Females",10,18) %>% 
 #  pack_rows("Males",19,26)
```

# Etude {.tabset}
## Fentes operées
```{r fentes operées}
tab(etude, cote_opere, round = 5) %>% 
    mutate("%"=prop*100) %>%
    adorn_totals() %>% 
    select(-prop,-cum_prop) %>% 
    flextable() %>% 
    set_table_properties(layout="autofit", width = 1) 


# table(etude$cote_opere) %>%
#     as.data.frame() %>%
#     mutate("%"=Freq*100/sum(Freq,na.rm=T)) %>%
#     adorn_totals() %>% 
#     kable(col.names = c("Coté operé","n","%")) %>% 
#     kable_paper() %>% 
#     kable_styling(bootstrap_options = c("striped", "hover"))
```

## Prelevement iliaque
```{r prelevement iliaque}
proc_freq(etude, "prelevement_iliaque") %>% 
set_header_labels(prelevement_iliaque= "Coté prélèvement iliaque", 
                  Count="N", 
                  Percent = "Percent") %>% 
    set_table_properties(layout = "autofit", width = 1)

# table(etude$prelevement_iliaque) %>% 
#     as.data.frame() %>%
#     mutate("%"=Freq*100/sum(Freq,na.rm=T)) %>% 
#     adorn_totals() %>% 
#     kable(col.names = c("Prelevement iliaque","n","%")) %>% 
#   kable_paper() %>% 
#     kable_styling(bootstrap_options = c("striped", "hover"))
```

## Age patients
Pour les patients qui ont éTé operés en 2 étapes je fais la moyenne des ages.
```{r pyramid}
g = etude %>% group_by(patid,sexe) %>% 
    summarise(age = mean(age/12)) %>% 
    mutate(age = cut(age, breaks = seq(0, 20, 1), include.lowest = TRUE)) %>% 
    ungroup() %>% 
    select(-patid) %>% 
    count(age,sexe) %>% 
    ggplot(aes(x = age, y = ifelse(sexe == "F", -n, n), fill = sexe)) +
    geom_bar(stat = "identity", position = "identity") +
    scale_y_continuous(labels = abs, breaks = seq(-20,20,1)) +
    labs(title = "Pyramide des âges", x = "Age (années)", y = "N", fill = "Sexe") +
    theme_minimal() +
    coord_flip()

# Printing plot
g

save_editable_plot(g,"pyramid des ages","graphs/")
```

```{r dispersion measures}
# Dispersion mesures
tab = etude %>% 
    group_by(patid) %>% 
    summarise(age=mean(age)) %$% 
    describe(age,fast = T) %>%
    round(2) %>% 
    as.data.frame %>%
    select(-1,-8)  

tab2 = tab %>% 
  mutate(across(mean:range, function(x) fmckage::convert_time(x,
                                                  from = "months", 
                                                  to = c("years","months","days"), 
                                                  warn_residual = F)))


all = tab2 %>% mutate(n="") %$% ifelse(.!="",paste0(tab," (",.,")"),tab) %>% 
  as.data.frame %>% 
  `colnames<-`(c("n","Mean","Sd","Min","Max","Range")) %>% 
  mutate(Gender = "") %>% relocate(Gender,.before = n)

# by females
tab = etude %>% filter(sexe=="F") %>% 
    group_by(patid) %>% 
    summarise(age=mean(age)) %$% 
    describe(age,fast = T) %>%
    round(2) %>% 
    as.data.frame %>%
    select(-1,-8)  

tab2 = tab %>% 
    mutate(across(mean:range, function(x) fmckage::convert_time(x,
                                                                from = "months", 
                                                                to = c("years","months","days"), 
                                                                warn_residual = F)))


f = tab2 %>% mutate(n="") %$% ifelse(.!="",paste0(tab," (",.,")"),tab) %>% 
    as.data.frame %>% 
    `colnames<-`(c("n","Mean","Sd","Min","Max","Range")) %>% 
    mutate(Gender = "F") %>% relocate(Gender,.before = n)

# By males
tab = etude %>% filter(sexe=="M") %>% 
    group_by(patid) %>% 
    summarise(age=mean(age)) %$% 
    describe(age,fast = T) %>%
    round(2) %>% 
    as.data.frame %>%
    select(-1,-8)  

tab2 = tab %>% 
    mutate(across(mean:range, function(x) fmckage::convert_time(x,
                                                                from = "months", 
                                                                to = c("years","months","days"), 
                                                                warn_residual = F)))


m = tab2 %>% mutate(n="") %$% ifelse(.!="",paste0(tab," (",.,")"),tab) %>% 
    as.data.frame %>% 
    `colnames<-`(c("n","Mean","Sd","Min","Max","Range")) %>% 
    mutate(Gender = "M") %>% relocate(Gender,.before = n)


# Dispersion mesures by sexe
# tab = etude %>% filter(sexe=="F") %>% 
#     group_by(patid) %>% 
#     summarise(age=mean(age)) %$% describe(age,fast = T) %>% 
#     select(-vars,-se) %>% 
#     mutate(across(mean:range, function(x) round(x, 2)))
#     
# tab1 = etude %>% filter(sexe=="M") %>% 
#     group_by(patid) %>% 
#     summarise(age=mean(age)) %$% describe(age,fast = T) %>% 
#     select(-vars,-se) %>% 
#     mutate(across(mean:range, function(x) round(x, 2)))
# 
# tab2 = rbind(tab,tab1) %>% tibble %>% 
#     mutate(across(mean:range ,function(x) convert_time(x,from = "months", to = c("years","months","days"))))
# 
# 
# by_sex <- tab %>%
#     mutate(mean = paste0(mean, " (", tab2$mean, ")"),
#            sd = paste0(sd, " (", tab2$sd, ")"),
#            min = paste0(min, " (", tab2$min, ")"),
#            max = paste0(max, " (", tab2$max, ")"),
#            range = paste0(range, " (", tab2$range, ")")) %>% 
#   rename(Gender=sexe) %>% `colnames<-`(c("Gender","n","Mean","Sd","Min","Max","Range"))


# Table
rbind(all, f, m) %>% 
    flextable %>%
    set_table_properties(width=1, layout="autofit")
# 
#     kable(row.names = F,
#           caption = "Age - Dispersion measures (months)") %>% 
#     kable_paper() %>% 
#     kable_styling(bootstrap_options = c("striped", "hover"))


```

## Traitement ODF
```{r ttt odf}
# 1) Combien de patients ont eu un traitement ODF pré chir ?
proc_freq(etude,"odf_prechir") %>% 
    set_table_properties(width=1,layout = "autofit")

# etude %>% 
#   distinct(patid, odf_prechir) %$%
#   table_prop(odf_prechir)  %>% 
#   kable(col.names = c("ODF prechir","n","%")) %>% 
#   kable_paper() %>%
#   add_footnote(c("ODF prechir 1/0 = oui/non",
#                  "NA = not available"))


# 2) temps moyen d’une prise en charge ODF avant la chirurgie 
tab = describe(etude$odf_prechir_months, fast = T) %>% round(2) %>% 
  select(-1,-8) %>% 
  as.data.frame() 

tab2 = etude %>%
  group_by(sexe) %>%
  summarise(odf_prechir_months = describe(odf_prechir_months, fast = T)) %>% 
  unnest(cols = odf_prechir_months) %>% 
  mutate(across(mean:range, round, 2)) %>% 
  select(-2,-9) %>%
  column_to_rownames("sexe")
  
tab3 = rbind(tab,tab2) %>% 
  mutate(across(mean:range, function(x) convert_time(x, from = "months", to = c("years","months","days"))))


    # joining tables
rbind(tab,tab2,tab3) %>% 
    flextable() %>% 
    set_table_properties(width=1,layout="autofit")
    
rbind(tab,tab2,tab3) %>%     
  `row.names<-`(c("Tous","F","M","tous","f","m")) %>% 
    kable(col.names = c("n", "moyenne", "écart type","min","max","range"), 
          row.names = T,
          caption = "Durée prise en charge ODF pre chir - Mesures de dispersion", 
          digits = 2) %>% 
  kable_paper() %>% 
  pack_rows("Mois",1,3) %>% 
  pack_rows("Years - months - days",4,6)

```

## Temps hospitalisation
```{r duree hospit}
# Mesures de dispersion
t_hospit = describe(etude$duree_sej, fast = T)[-c(1,8)] %>% round(2)

tab1 = t_hospit %>% 
    tibble %>% 
    mutate(across(mean:range, function(x) convert_time(x, from="days", to = c("days","hours"))))

tab2 = t_hospit %>%
    tibble %>% 
    mutate(across(mean:range, function(x) convert_time(x, from="days", to = c("hours","minutes"))))

    # Binding
rbind(as.character(t_hospit),tab1,tab2) %>%  
    mutate(rownames = c("","Days","Hours")) %>% 
    column_to_rownames(var = "rownames") %>% 
    kable(row.names = T, 
          caption = "Temps d'hispitalisation - mesures de dispersion", 
          col.names = c("n", "moyenne", "écart type","min","max","range")) %>%
    kable_paper()

# Table durée hospitalisation
table_prop(etude$duree_sej, name = "Durée hospit (jours)") %>% 
    kable(caption = "Tableau durée sejour") %>%
    kable_paper()

```


## Age intervention vs ODF
```{r}
plot(etude$age,etude$odf_prechir)

etude %>% 
    ggplot()+
    geom_boxplot(aes(x = factor(odf_prechir), y = age))+
    scale_y_continuous(breaks = seq(0,300,12), labels = function(x) x/12)

etude %>% 
    ggplot()+
    geom_boxplot(aes(x = etat_bd, y = age))+
    scale_y_continuous(breaks = seq(0,300,12), labels = function(x) x/12)

etude %>% 
    ggplot()+
    geom_boxplot(aes(x = compliance_ttt, y = age))+
    scale_y_continuous(breaks = seq(0,300,12), labels = function(x) x/12)

```



## Suites
```{r suites}
table_prop(etude$complications, name = "complications") %>% 
    kable(caption = "Suites compliquées oui/non") %>% 
    kable_paper()
```

# Learning curve{.tabset}
## Graphe
```{r learning curve, message=F}
# Plot
lc %>% 
  #filter(double==0) %>% 
ggplot(aes(x = as_date(date), y = time, color = factor(interne, labels = c("Oui","Non"))))+
    geom_point(position = "identity", aes(shape = factor(double)), size = 2.5)+
    scale_shape_manual(values=c(16, 17))+ 
    scale_y_continuous(breaks = seq(0,300,20))+
    scale_x_date(labels = as.character(seq(2010,2024,1)), date_breaks = "1 year")+
    geom_smooth(method="loess", span = 0.75)+
    labs(title = "Evolution temps d'intervention",
         y = "Temps (minutes)",
         x = "Date intervention",
         shape = "Intervention bilatérale",
         color = "Interne")
```

Les lignes colorées du graphique montrent la tendance moyenne dans le temps pour chaque groupe : une pour les cas où le chirurgien effectue l'opération seul, et une autre pour les cas où il était assisté par un interne. Il s'agit en quelque sorte d'une "meilleure estimation" de la durée moyenne de l'opération à une date donnée, sur la base des données dont nous disposons.

La zone ombrée autour de chaque ligne représente notre incertitude quant à cette "meilleure estimation". Elle nous indique que si nous devions deviner la durée moyenne des opérations à une certaine date, nous sommes sûrs à 95 % que la moyenne réelle se situerait dans cette zone ombrée.

Imagine d'essayer de deviner le poids d'un patient qu'en le regardant. Ton meilleure estimation pourrait être le poids moyen des patients que tu as vu auparavant. Mais tu sais aussi que les patients, à parité de volume, peuvent être un peu plus légers ou plus lourds que cette moyenne car ils n'ont pas la même composition corporelle. La zone ombrée revient à dire : "Je suis presque sûr que le poids de ce patient est de l'ordre de ce chiffre, à quelque chose près".

Dans ce contexte, la zone ombrée représente notre "à peu près" pour le temps d'intervention moyen. Plus la zone ombrée est large, plus notre "meilleure estimation" est incertaine. Comme on a moins de données "avec interne", le dégrée d'incertitude est plus élevé.

## Tendance: Mann-Kendall
```{r mannkendall, message=F}
# Mann-Kendall test on the sorted data
mk = lc %>% arrange(date) %>% filter(double==0) %$% MannKendall(time)
  # Printint the results nicely
cbind("Tau" = round(mk$tau,3), "p-value" = pval_format(mk$sl)) %>% kable(caption ="Mann-Kendall test") %>% kable_paper()
```

Pour tester formellement une tendance, nous pouvons utiliser le test de tendance de Mann-Kendall, un test non paramétrique largement utilisé pour détecter les tendances dans les données de séries temporelles. Le test ne suppose pas de distribution spécifique des données et il est particulièrement utile lorsqu'il s'agit de données qui ne sont pas normalement distribuées.

La valeur tau du test de Mann-Kendall est une mesure de la force et de la direction de la tendance. La valeur tau est comprise entre -1 (forte tendance à la baisse) et 1 (forte tendance à la hausse). Une valeur de 0 indique l'absence de tendance. Dans notre cas, le tau est de -0,587, ce qui suggère une "forte" tendance à la baisse.

La valeur p est une mesure de la signification statistique du résultat du test. La convention veut qu'une valeur p inférieure à 0,05 soit considérée comme statistiquement significative. Dans notre cas, la valeur p est inférieure à 2e-16 (*p<0.001*), ce qui est extrêmement faible et, par conséquent, le résultat est hautement significatif sur le plan statistique.

En résumé, les résultats du test de Mann-Kendall indiquent qu'il existe une forte tendance à la baisse du temps d'intervention du chirurgien au cours des 13 années, et cette tendance est statistiquement significative. Cela signifie qu'on dispose de preuves solides pour suggérer que le chirurgien devient effectivement plus rapide au fil du temps (ce qui n'est pas surprenant en soit mais c'est cool de le prouver).

J'au exclu du test statistique les interventions doubles (qui sont seulement 6).


## Interne oui vs interne non

Dans le graphe, le fait que les zones ombrées des deux groupes ne se chevauchent pas beaucoup nous indique qu'il existe une différence notable entre les deux scénarios : lorsque le chirurgien travaille seul et lorsqu'il est assisté. Cela n'est pas une surprise et le graphe parle tellement clair que faire un test stat est un peu ridicule mais voici ce que ça donne si on fait un test de student (pour comparer la durée moyenne entre "avec interne" et "sans interne"). A nouveau moi j'ai exclu les 6 interventions bilatérale dans ce test (seulement 1 bilatérale et avec interne). La différence entre la moyenne des 2 groupes est le temps que l'interne fait gagner en moyenne.

```{r interne impact}
surgeon_alone <- lc$time[lc$interne == 0 & lc$double==0]
surgeon_with_helper <- lc$time[lc$interne == 1 & lc$double==0]

tstudent = t.test(surgeon_alone, surgeon_with_helper)

# P-value
data.frame("P-value", pval_format(tstudent$p.value)) %>% kable(col.names = c("",""), caption = "Test t student") %>% kable_paper()

# Mean difference between the groups
tstudent$estimate %>% 
  as.data.frame(row.names = c("AVEC interne", "SANS interne")) %>% 
  `colnames<-`("Temps (minutes)") %>% 
  kable(caption = "Temps moyen d'intervention") %>% 
  kable_paper()

```


```{r linear regression, include = F}
# Trying a lm()
model <- lm(time ~ date, data = lc)
summary(model)

# Testing the assumption of linear model
    # Residuals vs Fitted values plot
plot(model, which = 1)
    # Q-Q plot
qqnorm(residuals(model))
qqline(residuals(model))
    # Shapiro-Wilk test
shapiro.test(residuals(model))
    # Durbin Watson Test
dwtest(model)

# Both the Shapiro-Wilk test for normality and the Durbin-Watson test for independence suggest violations of the assumptions of the linear regression model.
# 
# Normality assumption: The Shapiro-Wilk test p-value is very small, which provides evidence against the hypothesis that your residuals are normally distributed. It implies that the distribution of your residuals deviates from a normal distribution.
# 
# Independence assumption: The Durbin-Watson test p-value is less than 0.05, indicating that there is a statistically significant autocorrelation in the residuals, which means the independence assumption is violated.

```






